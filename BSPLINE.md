Базовые сплайны и сплайны Безье
===============================

## Безье-сплайны

Безье сплайны - разложение по полиномам в форме Бернштейна.
Кривая порядка $n$ задается через определение контрольных точек $\beta_{0}, ...,\beta_{n}$

$$B(t)=\sum _{k=0}^{n}\beta_{k}b_{k,n}(t),$$
где $b_{k,n}$ базовые полиномы Бернштейна 
$$b_{k,n} = \binom{n}{k}(1-t)^{n-k} t^k$$

Для построения сплайна используются рекуррентные соотношения с понижением степени сплайна, при этом пересчитываются узловые точки через сплайны первого порядка.
$$\beta_{k,0} = \beta_{i}$$
$$\beta_{k,n} = (1-t) b_{k,n-1} + t \cdot b_{k-1,n-1}$$

На практике используются линейные, квадратичные и кубические сплайны, которые рассчитываются через функцию `mix(a,b,t) = (1-t)*a + t*b` - линейную интерполяцию. 


```c
float spline(float b0, float b1, float t){
    return (1-t)*b0 + t*b1;
}
```
```c
float qspline(float b0, float b1, float b2, float t){
    b0 = spline(b0, b1, t);
    b2 = spline(b1, b2, t);
    b0 = spline(b0, b2, t);
    return b0;
}
```
Аналогично кубический сплайн определяется через квадратичные, рекурсивно
```c
float cspline(float b0, float b1, float b2, float b3, float t){
    b0 = qspline(b0, b1, b2, t);
    b3 = qspline(b1, b2, b3, t);
    b0 =  spline(b0, b3, t);
    return b0;
}
```
Различные сложные векторные изображения разбиваются на последовательность кубических сплайнов. В том числе дуги окружностей в векторной графике представлены сплайнами третьей степени с заданной точностью. 

При построении двумерных(трехмерных) сплайнов узловые точки задаются векторами.
$$\mathbf{B}(t)=\sum _{k=0}^{n}\mathbf{P}_{k}b_{k,n}(t),$$

Сплайн Безье можно задать через производные (касательные к кривой) в точках 0 и 1. 

Производная для сплайна Безье второй степени:
```math 
\mathbf{B}'(t)=2(1-t)(\mathbf{P}_{1}-\mathbf{P}_{0})+2t(\mathbf{P}_{2}-\mathbf{P}_{1}).
```

Производная для сплайна Безье третьей степени выглядит так:
```math 
\mathbf{B}'(t)=3(1-t)^{2}(\mathbf{P}_{1}-\mathbf{P}_{0})+6(1-t)t(\mathbf{P}_{2}-\mathbf{P}_{1})+3t^{2}(\mathbf{P}_{3}-\mathbf{P}_{2}).
```
можно записать как квадратичный сплайн.
А вторую производную через линейный сплайн
```math
\mathbf{B}''(t)=6(1-t)(\mathbf{P}_{2}-2\mathbf{P}_{1}+\mathbf{P}_{0})+6t(\mathbf{P}_{3}-2\mathbf{P}_{2}+\mathbf{P}_{1})
```
Вторая производная позволяет определить точки перегиба и высчитывать `bounding box` минимумы и максимумы. 

Если заданы производные $\mathbf{B}'(0)$, $\mathbf{B}'(1)$ узловые точки кубического сплайна определяются, как 
$$\mathbf{P}_1 = \mathbf{P}_0 + \mathbf{B}'(0)/3, \quad \mathbf{P}_2 = \mathbf{P}_3 + \mathbf{B}'(1)/3$$

Сплайн можно разбить на два сплайна. Удобно разбивать сплайны пополам в точке $(t=0.5)$. Полезно разбивать по точкам перегиба при растеризации векторного изображения или если необходимо понизить степень сплайна.

Сплайны активно стали применяться в машиностроении. Пьер Безье, который работал в компании Рено, запатентовал сплайны и метод задания кривых. Поль де Кастельжо, работал в компании Ситроен, разработал алгоритм построения спайна. Сплайны Безье основанные на базовых полиномах С.Н. Бернштейна стали использоваться для проектирования обводов кузовов в 1960х годах. Сергей Натанович Бернштейн опубликовал работу по базовым полиномам в связи с доказательством аппроксимационной теоремы Вейерштрасса еще в 1912 году. Аппроксимация полиномами в форме Бернштейна задается через значения функции в точках расположенных внутри интервала на равном расстоянии, в то время как кривые Безье определяют узловые точки иначе. 

У сплайнов Безье есть одна проблема - движение по траектории заданной сплайнами неравномерное. Это вызывает проблемы при задании анимации и при движении вдоль траектории. Для обеспечения постоянной (заданной) скорости перемещения вдоль сплайна применяются B-сплайны и NURB-сплайны (Non-uniform rational B-spline).

## Анимация на сплайнах Безье

Анимация в [W3C SMIL](https://www.w3.org/TR/SMIL3/smil-animation.html#adef-keySplines) формате определяется через набор ключевых точек по времени и скорости на единичном интервале. Скорости на интервале задаются кубическим сплайном Безье.

## B-сплайны - базовые сплайны 

Базовые сплайны задают тем же способом, что и финитные функции в функциональном анализе[^1]. Финитная функция обращается в ноль вне единичного интервала. 

Рекурсивный способ генерации полиномов
```math
{\displaystyle B_{i,0}(x):={\begin{cases}1&{\text{if }}\quad t_{i}\leq x<t_{i+1}\\0&{\text{otherwise}}\end{cases}}}
```
$$B_{i,p}(x):={\frac {x-t_{i}}{t_{i+p}-t_{i}}}B_{i,p-1}(x)+{\frac {t_{i+p+1}-x}{t_{i+p+1}-t_{i+1}}}B_{i+1,p-1}(x).$$

Слева и справа интервала образуются нули.
Если нас интересуют значения на интервале $t \in [t_{k}, t_{k+1})$, то сплайн дается суммой

$$\mathbf{S}(t)=\sum_{i=k-p}^{k}\mathbf{b}_{i} B_{i,p}(t).$$

## Кубические B-сплайны 

Кубический B-сплайн задает кривую $\mathbf{C}(t)$ от параметра $t \in [0,1]$ через узловые точки $\mathbf{b}_{0}, \mathbf{b}_{1}, \mathbf{b}_{2}, \mathbf{b}_{3}$ и может быть записан в матричной форме
```math
{\displaystyle \mathbf {C} (t)={\frac {1}{6}}\;
\begin{bmatrix}
t^{3} & t^{2} & t & 1
\end{bmatrix}
{\begin{bmatrix}
-1& 3&-3&1\\
 3&-6& 3&0\\
-3& 0& 3&0\\
 1& 4& 1&0
 \end{bmatrix}}{\begin{bmatrix}\mathbf {b} _{0}\\\mathbf {b} _{1}\\\mathbf {b} _{2}\\\mathbf {b} _{3}\end{bmatrix}}}.
```
кубический B-сплайн - разложение на полиномы третьей степени
Для узлов $(0,1,2,3)$

$$\mathbf {C} (t)=\sum _{i=0}^{3}B_{i}(t)\,\mathbf {b} _{i}.$$
```math
\begin{aligned}
B_{0}(t)&={\frac{1}{6}}(- t^{3}+3t^{2}-3t+1)\\
B_{1}(t)&={\frac{1}{6}}( 3t^{3}-6t^{2}   +4)\\
B_{2}(t)&={\frac{1}{6}}(-3t^{3}+3t^{2}+3t+1)\\
B_{3}(t)&={\frac{1}{6}}   t^{3}
\end{aligned}
```
Узловые точки сплайна Безье могут быть получены из узлов B-сплайна
```math
\begin{aligned}
\mathbf{P}_{0} &={\frac {1}{6}}(\mathbf{b}_{0} +4\mathbf{b}_{1}+\mathbf{b}_{2}),\\
\mathbf{P}_{1} &={\frac {1}{3}}(2\mathbf{b}_{1}+ \mathbf{b}_{2}),\\
\mathbf{P}_{2} &={\frac {1}{3}}(\mathbf{b}_{1} +2\mathbf{b}_{2}),\\
\mathbf{P}_{3} &={\frac {1}{6}}(\mathbf{b}_{1} +4\mathbf{b}_{2}+\mathbf{b}_{3}).
\end{aligned}
```




### Алгоритм Кокса-де Бура